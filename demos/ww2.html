<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>World War II Troop Movements (1939-1945)</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1DB24KTNYY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-1DB24KTNYY');
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Special+Elite&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --allied-color: rgba(65, 107, 178, 0.9);
      --allied-color-light: rgba(110, 158, 207, 0.7);
      --axis-color: rgba(204, 59, 45, 0.9);
      --axis-color-light: rgba(220, 95, 95, 0.7);
      --neutral-color: rgba(180, 180, 180, 0.8);
      --bg-color: #f3f1e9;
      --map-water: #cddee7;
      --map-land: #e8e0ca;
      --map-highlight: #f9f4dc;
      --text-primary: #2a2a2a;
      --text-secondary: #555555;
      --battle-color: rgba(255, 145, 0, 0.9);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto Slab', serif;
      background-color: var(--bg-color);
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23dbd5c0' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E");
      color: var(--text-primary);
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }

    header {
      text-align: center;
      margin-bottom: 25px;
      position: relative;
    }

    h1 {
      font-family: 'Special Elite', cursive;
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
      color: var(--text-primary);
      position: relative;
      display: inline-block;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 10%;
      right: 10%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--text-secondary), transparent);
    }

    .subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    .map-container {
      position: relative;
      width: 100%;
      height: 580px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      background: var(--map-water);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .map-container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
      z-index: 0;
      pointer-events: none;
    }

    #world-map {
      width: 100%;
      height: 100%;
    }

    .world-map-container {
      position: relative;
      height: 100%;
      width: 100%;
    }

    .zoom-controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 50;
    }

    .zoom-btn {
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
    }

    .zoom-btn:hover {
      background-color: #f9f9f9;
      transform: translateY(-1px);
      box-shadow: 0 3px 7px rgba(0, 0, 0, 0.15);
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg-color);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.5s ease-out;
    }

    .loading-message {
      margin-top: 20px;
      font-family: 'Special Elite', cursive;
      color: var(--text-secondary);
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--allied-color);
      border-left-color: var(--axis-color);
      animation: spin 1.2s ease-in-out infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .country {
      fill: var(--map-land);
      stroke: rgba(255, 255, 255, 0.5);
      stroke-width: 0.5;
      transition: fill 0.8s;
      vector-effect: non-scaling-stroke;
    }

    .axis {
      fill: var(--axis-color-light);
    }

    .allied {
      fill: var(--allied-color-light);
    }

    .occupied {
      fill: #e2bfbf;
      stroke-dasharray: 2, 1;
    }

    .neutral {
      fill: var(--neutral-color);
    }

    .country:hover {
      stroke: white;
      stroke-width: 1;
    }

    .movement-line {
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.3));
    }

    .allied-line {
      stroke: var(--allied-color);
    }

    .axis-line {
      stroke: var(--axis-color);
    }

    .battle-marker {
      filter: drop-shadow(0 0 4px rgba(255, 145, 0, 0.4));
    }

    .battle-point {
      fill: var(--battle-color);
      stroke: white;
      stroke-width: 1.5;
      transition: r 0.3s ease-out;
    }

    .battle-pulse {
      fill: var(--battle-color);
      opacity: 0;
    }

    @keyframes pulse {
      0% {
        opacity: 0.7;
        r: 5;
      }

      100% {
        opacity: 0;
        r: 20;
      }
    }

    .front-line {
      fill: none;
      stroke-width: 2;
      stroke-dasharray: 4, 2;
      stroke-linecap: round;
      filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.2));
    }

    .axis-front {
      stroke: var(--axis-color);
    }

    .allied-front {
      stroke: var(--allied-color);
    }

    .timeline-container {
      position: relative;
      margin-top: 30px;
      padding: 10px 20px 30px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .war-phases {
      position: relative;
      height: 36px;
      margin-bottom: 8px;
    }

    .phase {
      position: absolute;
      top: 0;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.03);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: bold;
      padding: 0 15px;
      font-family: 'Special Elite', cursive;
    }

    .timeline {
      position: relative;
      height: 60px;
      background-color: rgba(0, 0, 0, 0.03);
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .timeline-track {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 4px;
      background-color: rgba(0, 0, 0, 0.15);
      transform: translateY(-50%);
    }

    .year-markers {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .year-marker {
      position: absolute;
      top: 35%;
      width: 1px;
      height: 15px;
      background-color: rgba(0, 0, 0, 0.3);
      transform: translateX(-50%);
    }

    .year-label {
      position: absolute;
      bottom: -20px;
      transform: translateX(-50%);
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: bold;
    }

    .event-marker {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 14px;
      height: 14px;
      background-color: #fff;
      border: 2px solid var(--text-secondary);
      border-radius: 50%;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s ease;
    }

    .event-marker:hover {
      transform: translate(-50%, -50%) scale(1.3);
      border-color: var(--text-primary);
      box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
    }

    .event-marker.active {
      transform: translate(-50%, -50%) scale(1.2);
      background-color: var(--text-primary);
      border-color: white;
      box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.15);
    }

    .event-marker.axis-event {
      border-color: var(--axis-color);
    }

    .event-marker.allied-event {
      border-color: var(--allied-color);
    }

    .event-marker.major-event {
      border-width: 3px;
    }

    .timeline-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      white-space: nowrap;
      pointer-events: none;
      z-index: 100;
    }

    .timeline-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
    }

    .event-marker:hover .timeline-tooltip {
      opacity: 1;
      visibility: visible;
      bottom: 30px;
    }

    .timeline-progress {
      position: absolute;
      top: 50%;
      left: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--allied-color) 0%, var(--axis-color) 50%, var(--allied-color) 100%);
      transform: translateY(-50%);
      z-index: 5;
    }

    .time-indicator {
      position: absolute;
      top: 50%;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: white;
      border: 4px solid var(--text-primary);
      transform: translate(-50%, -50%);
      z-index: 20;
      box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
    }

    .current-date {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--text-primary);
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.9rem;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      white-space: nowrap;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    .control-button {
      padding: 8px 20px;
      border: none;
      border-radius: 4px;
      background-color: var(--text-primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Roboto Slab', serif;
    }

    .control-button:hover {
      background-color: #3a3a3a;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .control-button:active {
      transform: translateY(0);
    }

    .control-button:disabled {
      background-color: var(--neutral-color);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .theaters-control {
      display: flex;
      position: absolute;
      right: 15px;
      top: 15px;
      z-index: 50;
    }

    .theater-button {
      padding: 6px 12px;
      border: none;
      background-color: white;
      border: 1px solid rgba(0, 0, 0, 0.1);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Roboto Slab', serif;
    }

    .theater-button:first-child {
      border-radius: 4px 0 0 4px;
    }

    .theater-button:last-child {
      border-radius: 0 4px 4px 0;
    }

    .theater-button.active {
      background-color: var(--text-primary);
      color: white;
      border-color: var(--text-primary);
    }

    .theater-button:not(.active):hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .info-panel {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 280px;
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      z-index: 30;
      opacity: 0;
      transform: translateX(20px);
      transition: all 0.3s;
      max-height: 90%;
      overflow-y: auto;
      pointer-events: auto;
    }

    .info-panel.active {
      opacity: 1;
      transform: translateX(0);
    }

    .info-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .current-event-date {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: bold;
    }

    .close-btn {
      border: none;
      background: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: var(--text-secondary);
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-btn:hover {
      background-color: rgba(0, 0, 0, 0.05);
      color: var(--text-primary);
    }

    .event-title {
      font-size: 1.1rem;
      margin-bottom: 10px;
      line-height: 1.3;
      font-weight: bold;
      color: var(--text-primary);
    }

    .event-description {
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 15px;
      color: var(--text-secondary);
    }

    .event-stats {
      background-color: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.85rem;
    }

    .stat-row:last-child {
      margin-bottom: 0;
    }

    .stat-label {
      color: var(--text-secondary);
    }

    .stat-value {
      font-weight: bold;
      color: var(--text-primary);
    }

    .tooltip {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
      max-width: 250px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s;
      z-index: 100;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .legend {
      position: absolute;
      left: 15px;
      bottom: 65px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 20;
      font-size: 0.8rem;
    }

    .legend-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: var(--text-primary);
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }

    .legend-item:last-child {
      margin-bottom: 0;
    }

    .legend-color {
      width: 20px;
      height: 8px;
      margin-right: 10px;
      border-radius: 2px;
    }

    .legend-circle {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .legend-label {
      color: var(--text-secondary);
    }

    .year-progress {
      position: absolute;
      top: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.03);
      z-index: 1;
    }

    .troop-marker {
      fill: none;
      stroke-linecap: round;
      stroke-width: 5;
      opacity: 0.8;
    }

    .allied-troops {
      stroke: var(--allied-color);
      stroke-dasharray: 1, 10;
      animation: march 1s infinite linear;
    }

    .axis-troops {
      stroke: var(--axis-color);
      stroke-dasharray: 1, 10;
      animation: march 1s infinite linear;
    }

    @keyframes march {
      to {
        stroke-dashoffset: -11;
      }
    }

    .battle-detail {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .battle-title {
      font-weight: bold;
      font-size: 0.95rem;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .battle-info {
      font-size: 0.85rem;
      line-height: 1.5;
      color: var(--text-secondary);
    }

    .fade-in {
      animation: fadeIn 0.5s forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background-color: var(--text-primary);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 0.9rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: all 0.5s;
      z-index: 1000;
    }

    .notification.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    @media (max-width: 992px) {
      .info-panel {
        width: 250px;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      h1 {
        font-size: 1.8rem;
      }

      .map-container {
        height: 450px;
      }

      .info-panel {
        width: 220px;
      }

      .event-title {
        font-size: 1rem;
      }

      .timeline-container {
        padding: 10px;
      }

      .event-marker {
        width: 12px;
        height: 12px;
      }
    }

    @media (max-width: 576px) {
      .map-container {
        height: 350px;
      }

      .info-panel {
        position: fixed;
        top: auto;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        max-height: 50%;
        border-radius: 15px 15px 0 0;
        transform: translateY(100%);
      }

      .info-panel.active {
        transform: translateY(0);
      }

      .theaters-control {
        top: auto;
        bottom: 15px;
      }

      .legend {
        bottom: 115px;
      }

      .zoom-controls {
        bottom: 70px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>World War II Troop Movements (1939-1945)</h1>
      <p class="subtitle">A visualization of major military operations and territorial changes</p>
    </header>

    <div class="map-container">
      <div class="loading-overlay">
        <div class="spinner"></div>
        <p class="loading-message">Loading World War II data...</p>
      </div>

      <div class="theaters-control">
        <button class="theater-button active" data-theater="global">Global</button>
        <button class="theater-button" data-theater="europe">Europe</button>
        <button class="theater-button" data-theater="pacific">Pacific</button>
        <button class="theater-button" data-theater="africa">Africa</button>
      </div>

      <div class="world-map-container">
        <svg id="world-map" viewBox="0 0 960 500" preserveAspectRatio="xMidYMid meet"></svg>
      </div>

      <div class="zoom-controls">
        <button class="zoom-btn" id="zoom-in">+</button>
        <button class="zoom-btn" id="zoom-out">−</button>
        <button class="zoom-btn" id="zoom-reset">⟲</button>
      </div>

      <div class="legend">
        <div class="legend-title">Legend</div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: var(--allied-color);"></div>
          <span class="legend-label">Allied Forces</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: var(--axis-color);"></div>
          <span class="legend-label">Axis Forces</span>
        </div>
        <div class="legend-item">
          <div class="legend-circle" style="background-color: var(--battle-color);"></div>
          <span class="legend-label">Major Battles</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: var(--allied-color-light);"></div>
          <span class="legend-label">Allied Territory</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: var(--axis-color-light);"></div>
          <span class="legend-label">Axis Territory</span>
        </div>
      </div>

      <div class="info-panel">
        <div class="info-panel-header">
          <div class="current-event-date" id="current-event-date"></div>
          <button class="close-btn">&times;</button>
        </div>
        <h2 class="event-title" id="event-title"></h2>
        <div class="event-description" id="event-description"></div>
        <div class="event-stats" id="event-stats"></div>
        <div class="battle-detail" id="battle-detail"></div>
      </div>

      <div class="tooltip"></div>
    </div>

    <div class="timeline-container">
      <div class="war-phases" id="war-phases">
        <!-- War phases will be added dynamically -->
      </div>

      <div class="timeline">
        <div class="timeline-track"></div>
        <div class="year-markers" id="year-markers">
          <!-- Year markers will be added dynamically -->
        </div>
        <div class="timeline-progress" id="timeline-progress"></div>
        <div class="time-indicator" id="time-indicator">
          <div class="current-date" id="current-date"></div>
        </div>
        <!-- Event markers will be added dynamically -->
      </div>

      <div class="controls">
        <button class="control-button" id="play-pause-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 5V19L19 12L8 5Z" fill="currentColor" />
          </svg>
          Play
        </button>
        <button class="control-button" id="previous-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 6L9 12L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
          Previous
        </button>
        <button class="control-button" id="next-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
          Next
        </button>
        <button class="control-button" id="reset-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12Z"
              stroke="currentColor" stroke-width="2" />
            <path d="M16 12L8 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            <path d="M12 8L8 12L12 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
          Reset
        </button>
      </div>
    </div>

    <div class="notification" id="notification"></div>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // ===== Visualization Configuration =====
      const config = {
        animationDuration: 1500,
        pauseBetweenEvents: 3000,
        zoomExtent: [1, 8],
        defaultZoom: 1.2
      };

      // ===== Visualization State =====
      const state = {
        currentEventIndex: 0,
        isPlaying: false,
        animationTimer: null,
        currentPhase: null,
        activeTheater: 'global',
        zoomLevel: config.defaultZoom,
        mapTranslate: [0, 0],
        tooltipTimer: null,
        notification: null,
        notificationTimer: null
      };

      // ===== D3 Setup =====
      const width = 960;
      const height = 500;
      const svg = d3.select('#world-map');

      // Create zoom behavior
      const zoom = d3.zoom()
        .scaleExtent(config.zoomExtent)
        .on('zoom', (event) => {
          state.zoomLevel = event.transform.k;
          state.mapTranslate = [event.transform.x, event.transform.y];
          svg.select('.world-map-group').attr('transform', event.transform);
        });

      svg.call(zoom);

      // Initial transform
      const initialTransform = d3.zoomIdentity
        .translate(0, 0)
        .scale(config.defaultZoom);

      svg.call(zoom.transform, initialTransform);

      // Create map projection
      const projection = d3.geoMercator()
        .scale(150)
        .translate([width / 2, height / 1.5]);

      const path = d3.geoPath().projection(projection);

      // Initialize tooltip
      const tooltip = d3.select('.tooltip');

      // ===== War Phases =====
      const warPhases = [
        { name: "Axis Expansion", start: new Date(1939, 8, 1), end: new Date(1941, 11, 7), color: "rgba(204, 59, 45, 0.15)" },
        { name: "Turning Point", start: new Date(1941, 11, 7), end: new Date(1943, 6, 5), color: "rgba(150, 150, 150, 0.15)" },
        { name: "Allied Advance", start: new Date(1943, 6, 5), end: new Date(1945, 7, 15), color: "rgba(65, 107, 178, 0.15)" }
      ];

      // ===== Historical Events =====
      const events = [
        {
          id: 1,
          date: new Date(1939, 8, 1),
          title: "Germany Invades Poland",
          description: "Nazi Germany launches a massive invasion of Poland using Blitzkrieg tactics, triggering Britain and France to declare war two days later. This marks the beginning of World War II in Europe.",
          phase: "Axis Expansion",
          type: "axis",
          significance: "major",
          stats: {
            "German Forces": "1.5 million troops",
            "Polish Forces": "950,000 troops",
            "Duration": "35 days",
            "Casualties": "High (16,000 German, 66,000 Polish)"
          },
          movements: [
            { type: "axis", path: [[14.5, 53.5], [16, 53], [18, 52.3], [19, 52]], name: "German Northern Advance", units: "800,000 troops", speed: "Fast", intensity: 3 },
            { type: "axis", path: [[15.5, 51], [17, 51.5], [19, 51.1]], name: "German Central Advance", units: "400,000 troops", speed: "Fast", intensity: 2 },
            { type: "axis", path: [[16.8, 50.3], [18, 50.1], [19.9, 50]], name: "German Southern Advance", units: "300,000 troops", speed: "Fast", intensity: 2 }
          ],
          battles: [
            { coords: [21, 52.2], name: "Battle of Warsaw", date: "Sept 8-28, 1939", outcome: "German victory", scale: "Major", significance: 3 }
          ],
          frontLines: [
            { type: "axis", path: [[14.5, 54.8], [16, 54], [18, 53], [19, 52], [20, 51], [20.5, 50.3], [21, 49.5]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [19, 52], zoom: 4 }
        },
        {
          id: 2,
          date: new Date(1939, 10, 30),
          title: "Soviet-Finnish Winter War",
          description: "The Soviet Union invades Finland, expecting a quick victory. However, the Finnish forces mount a surprisingly effective resistance in the harsh winter conditions, inflicting heavy casualties on the Red Army.",
          phase: "Axis Expansion",
          type: "axis",
          significance: "medium",
          stats: {
            "Soviet Forces": "450,000 troops",
            "Finnish Forces": "300,000 troops",
            "Duration": "105 days",
            "Casualties": "Heavy (Soviet: 126,000, Finnish: 25,000)"
          },
          movements: [
            { type: "axis", path: [[32, 61], [30, 61], [28, 61]], name: "Soviet Northern Offensive", units: "450,000 troops", speed: "Slow", intensity: 2 },
            { type: "allied", path: [[28, 63], [29.5, 62.5]], name: "Finnish Counter-Attack", units: "50,000 troops", speed: "Medium", intensity: 1 }
          ],
          battles: [
            { coords: [28.5, 61], name: "Battle of Suomussalmi", date: "Dec 1939 - Jan 1940", outcome: "Finnish victory", scale: "Significant", significance: 2 }
          ],
          frontLines: [
            { type: "axis", path: [[27.5, 60], [28, 61], [29, 62], [30, 63], [31, 64], [32, 64.5]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [30, 62], zoom: 4 }
        },
        {
          id: 3,
          date: new Date(1940, 3, 9),
          title: "Germany Invades Denmark and Norway",
          description: "Nazi Germany launches Operation Weserübung, invading Denmark and Norway to secure iron ore supplies from Sweden and gain strategic naval bases for the Atlantic campaign.",
          phase: "Axis Expansion",
          type: "axis",
          significance: "medium",
          stats: {
            "German Forces": "120,000 troops",
            "Norwegian Forces": "45,000 troops",
            "Duration": "62 days",
            "Allied Intervention": "British, French, and Polish forces"
          },
          movements: [
            { type: "axis", path: [[10, 54], [10, 56]], name: "Invasion of Denmark", units: "100,000 troops", speed: "Fast", intensity: 2 },
            { type: "axis", path: [[10, 54], [7, 58], [8, 60], [10, 63]], name: "Invasion of Norway", units: "120,000 troops", speed: "Medium", intensity: 2 },
            { type: "allied", path: [[-2, 55], [4, 59], [6, 60]], name: "British Naval Intervention", units: "28,000 troops", speed: "Medium", intensity: 1 }
          ],
          battles: [
            { coords: [10.7, 59.9], name: "Battle of Drøbak Sound", date: "April 9, 1940", outcome: "Norwegian tactical victory", scale: "Limited", significance: 1 },
            { coords: [10.4, 63.4], name: "Battle of Narvik", date: "April 10-June 8, 1940", outcome: "Initial Allied victory, later German control", scale: "Significant", significance: 2 }
          ],
          frontLines: [
            { type: "axis", path: [[8, 57], [9, 58], [8.5, 60], [9, 61], [10, 63], [11, 64], [12, 65]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [10, 60], zoom: 3.5 }
        },
        {
          id: 4,
          date: new Date(1940, 4, 10),
          title: "Battle of France Begins",
          description: "Germany invades France, Belgium, Luxembourg and the Netherlands, bypassing the Maginot Line through the Ardennes Forest. The Blitzkrieg tactics lead to a swift German victory and the division of France.",
          phase: "Axis Expansion",
          type: "axis",
          significance: "major",
          stats: {
            "German Forces": "3.35 million troops",
            "Allied Forces": "3.3 million troops",
            "Duration": "46 days",
            "Casualties": "Severe (German: 157,000, Allies: over 360,000)"
          },
          movements: [
            { type: "axis", path: [[6, 50], [4.5, 49.5], [3, 48]], name: "German Invasion through Ardennes", units: "1.5 million troops", speed: "Fast", intensity: 3 },
            { type: "axis", path: [[6, 51], [5, 50.8], [4.5, 50.8], [4, 50.5]], name: "Invasion of Belgium", units: "800,000 troops", speed: "Fast", intensity: 3 },
            { type: "axis", path: [[6, 52], [5, 51.8]], name: "Invasion of Netherlands", units: "750,000 troops", speed: "Fast", intensity: 2 },
            { type: "allied", path: [[2, 49], [3.5, 50], [4, 50.5]], name: "Allied Counter-movement", units: "1.3 million troops", speed: "Slow", intensity: 2 }
          ],
          battles: [
            { coords: [2.3, 48.9], name: "Fall of Paris", date: "June 14, 1940", outcome: "German occupation", scale: "Major", significance: 3 },
            { coords: [4.5, 50.5], name: "Battle of Sedan", date: "May 12-15, 1940", outcome: "German breakthrough", scale: "Critical", significance: 3 }
          ],
          frontLines: [
            { type: "axis", path: [[2, 51], [2.5, 50], [2, 49], [1.5, 48], [2, 47], [3, 46.5], [5, 46], [6, 46], [7, 46.5]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [4, 49], zoom: 4 }
        },
        {
          id: 5,
          date: new Date(1940, 5, 26),
          title: "Dunkirk Evacuation",
          description: "Allied forces evacuate from Dunkirk in a desperate retreat as German forces advance. Operation Dynamo rescues over 338,000 British, French, and Belgian troops, saving them from capture and allowing Britain to continue the fight.",
          phase: "Axis Expansion",
          type: "allied",
          significance: "major",
          stats: {
            "Evacuated Troops": "338,226 soldiers",
            "Naval Vessels": "861 vessels (including civilian ships)",
            "Duration": "9 days",
            "Lost Equipment": "Massive (2,472 guns, 20,000 motorcycles, 65,000 vehicles)"
          },
          movements: [
            { type: "allied", path: [[2.4, 51], [1.2, 51], [0, 51], [-1.5, 51]], name: "Dunkirk Evacuation", units: "338,000 troops", speed: "Medium", intensity: 3 },
            { type: "axis", path: [[3, 50.7], [2.6, 50.9]], name: "German Encirclement", units: "800,000 troops", speed: "Medium", intensity: 2 }
          ],
          battles: [
            { coords: [2.37, 51.05], name: "Defense of Dunkirk", date: "May 26 - June 4, 1940", outcome: "Successful Allied evacuation", scale: "Critical", significance: 3 }
          ],
          frontLines: [
            { type: "axis", path: [[1.5, 51.2], [2, 51], [2.5, 50.8], [3, 50.5], [2.5, 50], [2, 49], [1, 48], [1.5, 47], [2.5, 46.5], [4, 46], [6, 46]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [2, 50.5], zoom: 5 }
        },
        {
          id: 6,
          date: new Date(1940, 6, 10),
          title: "Battle of Britain",
          description: "The Luftwaffe attempts to gain air superiority over the Royal Air Force, a prerequisite for the planned invasion of Britain (Operation Sea Lion). The RAF's successful defense forces Hitler to postpone the invasion indefinitely.",
          phase: "Axis Expansion",
          type: "axis",
          significance: "major",
          stats: {
            "German Aircraft": "2,600",
            "British Aircraft": "1,963",
            "Duration": "3.5 months",
            "Casualties": "German: 1,977 aircraft, British: 1,023 aircraft"
          },
          movements: [
            { type: "axis", path: [[3, 50], [1.5, 50.5], [0, 51]], name: "Luftwaffe Air Campaign", units: "2,600 aircraft", speed: "Fast", intensity: 3 }
          ],
          battles: [
            { coords: [0.5, 51.5], name: "Air Battles over Southern England", date: "July - October 1940", outcome: "British victory", scale: "Decisive", significance: 3 }
          ],
          frontLines: [],
          theaters: ["europe"],
          mapFocus: { center: [0, 51], zoom: 4.5 }
        },
        {
          id: 7,
          date: new Date(1940, 9, 28),
          title: "Italy Invades Greece",
          description: "Italy launches an invasion of Greece from Albania, opening a new front in the Balkans. Despite numerical superiority, Italian forces are repelled and pushed back into Albania, forcing Germany to intervene later.",
          phase: "Axis Expansion",
          type: "axis",
          significance: "medium",
          stats: {
            "Italian Forces": "150,000 troops",
            "Greek Forces": "260,000 troops",
            "Duration": "Initial phase: 6 months",
            "Italian Advance": "Minimal before counter-attack"
          },
          movements: [
            { type: "axis", path: [[20, 41], [20.5, 40], [21, 39.5]], name: "Italian Invasion of Greece", units: "150,000 troops", speed: "Slow", intensity: 2 },
            { type: "allied", path: [[21.5, 39], [21, 40], [20.5, 40.5]], name: "Greek Counter-offensive", units: "260,000 troops", speed: "Medium", intensity: 2 }
          ],
          battles: [
            { coords: [21, 40], name: "Battle of Pindus", date: "Oct-Nov 1940", outcome: "Greek victory", scale: "Significant", significance: 2 }
          ],
          frontLines: [
            { type: "allied", path: [[19.5, 41.5], [20, 41], [20.2, 40.5], [20.5, 40], [20.5, 39.5]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [21, 40], zoom: 5 }
        },
        {
          id: 8,
          date: new Date(1941, 3, 6),
          title: "Germany Invades Yugoslavia and Greece",
          description: "Nazi Germany invades both Yugoslavia and Greece to support the failing Italian campaign and secure its southern flank before the planned invasion of the Soviet Union. Both countries fall within weeks.",
          phase: "Axis Expansion",
          type: "axis",
          significance: "medium",
          stats: {
            "Axis Forces": "1.2 million troops",
            "Greek & Yugoslav Forces": "700,000 troops",
            "British Expeditionary Force": "62,000 troops",
            "Duration": "24 days"
          },
          movements: [
            { type: "axis", path: [[15, 47], [18, 45], [19, 44], [18, 43]], name: "Invasion of Yugoslavia", units: "700,000 troops", speed: "Fast", intensity: 3 },
            { type: "axis", path: [[23, 42], [22, 41], [23, 40]], name: "Invasion of Greece", units: "500,000 troops", speed: "Fast", intensity: 2 },
            { type: "allied", path: [[23, 38], [23, 37]], name: "British Evacuation", units: "50,000 troops", speed: "Medium", intensity: 1 }
          ],
          battles: [
            { coords: [20.5, 38.5], name: "Battle of Greece", date: "April 6-30, 1941", outcome: "Axis victory", scale: "Major", significance: 2 },
            { coords: [20.5, 44.8], name: "Battle of Belgrade", date: "April 6-12, 1941", outcome: "German victory", scale: "Decisive", significance: 2 }
          ],
          frontLines: [
            { type: "axis", path: [[18, 46], [19, 45], [20, 44], [19, 43], [20, 42], [21, 41], [21.5, 40], [22, 39], [23, 38.5], [24, 38], [24.5, 37]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [20, 42], zoom: 4 }
        },
        {
          id: 9,
          date: new Date(1941, 5, 22),
          title: "Operation Barbarossa",
          description: "Nazi Germany launches a massive invasion of the Soviet Union along a 1,800-mile front, the largest military operation in history. The attack initially advances rapidly but bogs down as winter approaches Moscow.",
          phase: "Axis Expansion",
          type: "axis",
          significance: "major",
          stats: {
            "Axis Forces": "3.8 million troops",
            "Soviet Forces": "2.9 million troops",
            "Front Width": "1,800 miles",
            "Casualties": "Massive (Millions on both sides)"
          },
          movements: [
            { type: "axis", path: [[23, 54], [26, 55], [30, 56]], name: "Army Group North", units: "700,000 troops", speed: "Fast", intensity: 3 },
            { type: "axis", path: [[23, 52], [27, 53], [32, 54]], name: "Army Group Center", units: "1.3 million troops", speed: "Fast", intensity: 3 },
            { type: "axis", path: [[26, 48], [30, 48], [34, 48]], name: "Army Group South", units: "900,000 troops", speed: "Fast", intensity: 3 },
            { type: "allied", path: [[36, 55], [34, 55]], name: "Soviet Retreat", units: "800,000 troops", speed: "Medium", intensity: 2 }
          ],
          battles: [
            { coords: [37.6, 55.7], name: "Battle of Moscow", date: "Oct 1941 - Jan 1942", outcome: "Soviet defensive victory", scale: "Decisive", significance: 3 },
            { coords: [32, 54.5], name: "Battle of Smolensk", date: "July-Sept 1941", outcome: "German tactical victory", scale: "Major", significance: 2 },
            { coords: [30.5, 50.4], name: "Battle of Kiev", date: "Aug-Sept 1941", outcome: "German victory", scale: "Major", significance: 2 }
          ],
          frontLines: [
            { type: "axis", path: [[28, 60], [30, 58], [32, 56], [35, 55.5], [36, 54], [36, 52], [34, 50], [32, 48], [30, 46], [28, 45]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [32, 52], zoom: 3 }
        },
        {
          id: 10,
          date: new Date(1941, 11, 7),
          title: "Pearl Harbor Attack",
          description: "Japan launches a surprise attack on the US Pacific Fleet at Pearl Harbor, Hawaii, bringing the United States into the war. The attack damages or destroys 19 ships and 328 aircraft, and kills 2,403 Americans.",
          phase: "Turning Point",
          type: "axis",
          significance: "major",
          stats: {
            "Japanese Aircraft": "353",
            "US Ships Lost/Damaged": "19",
            "US Aircraft Destroyed": "328",
            "US Casualties": "2,403 killed, 1,178 wounded"
          },
          movements: [
            { type: "axis", path: [[138, 35], [165, 30], [-157.8, 21.3]], name: "Japanese Naval Attack", units: "6 aircraft carriers, 408 aircraft", speed: "Fast", intensity: 3 }
          ],
          battles: [
            { coords: [-157.8, 21.3], name: "Attack on Pearl Harbor", date: "Dec 7, 1941", outcome: "Japanese tactical victory", scale: "Strategic", significance: 3 }
          ],
          frontLines: [],
          theaters: ["pacific"],
          mapFocus: { center: [-157.8, 21.3], zoom: 8 }
        },
        {
          id: 11,
          date: new Date(1942, 5, 4),
          title: "Battle of Midway",
          description: "A decisive naval battle in which US forces defeat the Japanese navy, marking a turning point in the Pacific War. Japan loses four aircraft carriers and experienced aviators they cannot replace.",
          phase: "Turning Point",
          type: "allied",
          significance: "major",
          stats: {
            "Japanese Carriers": "4 lost (Akagi, Kaga, Soryu, Hiryu)",
            "US Carriers": "1 lost (Yorktown)",
            "Japanese Aircraft Lost": "248",
            "Japanese Casualties": "3,057 killed"
          },
          movements: [
            { type: "axis", path: [[150, 35], [165, 30], [177, 28]], name: "Japanese Fleet Movement", units: "4 fleet carriers, 272 aircraft", speed: "Fast", intensity: 2 },
            { type: "allied", path: [[-158, 21], [170, 25], [177, 28]], name: "US Naval Forces", units: "3 fleet carriers, 233 aircraft", speed: "Fast", intensity: 2 }
          ],
          battles: [
            { coords: [177.37, 28.2], name: "Battle of Midway", date: "June 4-7, 1942", outcome: "Decisive American victory", scale: "Strategic", significance: 3 }
          ],
          frontLines: [],
          theaters: ["pacific"],
          mapFocus: { center: [175, 28], zoom: 3.5 }
        },
        {
          id: 12,
          date: new Date(1942, 7, 7),
          title: "Guadalcanal Campaign",
          description: "The first major offensive by Allied forces against Japan in the Pacific, marking the beginning of the island-hopping strategy. After six months of fierce fighting, the Japanese withdraw from Guadalcanal.",
          phase: "Turning Point",
          type: "allied",
          significance: "major",
          stats: {
            "US Forces": "60,000 troops",
            "Japanese Forces": "36,000 troops",
            "Duration": "6 months",
            "Naval Battles": "7 major engagements"
          },
          movements: [
            { type: "allied", path: [[-158, 21], [180, 0], [160, -9.5]], name: "US Marine Landings", units: "16,000 troops", speed: "Medium", intensity: 2 },
            { type: "axis", path: [[153, 35], [158, 0], [160, -9.5]], name: "Japanese Reinforcements", units: "30,000 troops", speed: "Medium", intensity: 1 }
          ],
          battles: [
            { coords: [160, -9.5], name: "Battle of Guadalcanal", date: "Aug 1942 - Feb 1943", outcome: "Allied victory", scale: "Decisive", significance: 3 }
          ],
          frontLines: [],
          theaters: ["pacific"],
          mapFocus: { center: [160, -9.5], zoom: 5 }
        },
        {
          id: 13,
          date: new Date(1942, 10, 23),
          title: "Battle of Stalingrad",
          description: "One of the bloodiest battles in history, as Soviet forces encircle and destroy the German 6th Army. The devastating German defeat marks a turning point on the Eastern Front and the beginning of Soviet advances westward.",
          phase: "Turning Point",
          type: "allied",
          significance: "major",
          stats: {
            "German Forces": "270,000 troops (initially)",
            "Soviet Forces": "Over 1 million troops",
            "Duration": "5 months",
            "German Casualties": "Nearly total (90,000 captured)"
          },
          movements: [
            { type: "axis", path: [[38, 49], [41, 48.5], [44, 48]], name: "German 6th Army Advance", units: "270,000 troops", speed: "Medium", intensity: 3 },
            { type: "allied", path: [[46, 51], [45, 49.5], [44, 48]], name: "Soviet Northern Pincer", units: "500,000+ troops", speed: "Fast", intensity: 3 },
            { type: "allied", path: [[46, 45], [45, 46.5], [44, 48]], name: "Soviet Southern Pincer", units: "500,000+ troops", speed: "Fast", intensity: 3 }
          ],
          battles: [
            { coords: [44.5, 48.7], name: "Battle of Stalingrad", date: "Aug 1942 - Feb 1943", outcome: "Decisive Soviet victory", scale: "Strategic", significance: 3 }
          ],
          frontLines: [
            { type: "axis", path: [[34, 60], [36, 58], [38, 57], [40, 53], [42, 51], [43, 49], [44, 48], [43, 47], [40, 45], [38, 44], [36, 43]] },
            { type: "allied", path: [[42, 51], [43, 49.5], [45, 48.5], [46, 47.5], [43, 47], [40, 45], [38, 44], [36, 43]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [44, 49], zoom: 5 }
        },
        {
          id: 14,
          date: new Date(1943, 6, 5),
          title: "Battle of Kursk",
          description: "The largest tank battle in history and the last major German offensive on the Eastern Front. The Soviet victory ends German hopes of regaining initiative in the East and leads to a series of Soviet counter-offensives.",
          phase: "Allied Advance",
          type: "allied",
          significance: "major",
          stats: {
            "German Forces": "900,000 troops, 2,700 tanks",
            "Soviet Forces": "1.9 million troops, 5,000 tanks",
            "Area": "450 km salient",
            "German Tank Losses": "760 destroyed"
          },
          movements: [
            { type: "axis", path: [[35, 51], [36, 51.5], [37, 52]], name: "Operation Citadel North", units: "900,000 troops", speed: "Slow", intensity: 3 },
            { type: "axis", path: [[35, 49], [36, 49.5], [37, 50]], name: "Operation Citadel South", units: "900,000 troops", speed: "Slow", intensity: 3 },
            { type: "allied", path: [[38, 52], [37.5, 52], [37, 52]], name: "Soviet Defense North", units: "1.3 million troops", speed: "Medium", intensity: 3 },
            { type: "allied", path: [[38, 50], [37.5, 50], [37, 50]], name: "Soviet Defense South", units: "1.3 million troops", speed: "Medium", intensity: 3 }
          ],
          battles: [
            { coords: [36.5, 51.7], name: "Battle of Kursk", date: "July 5-23, 1943", outcome: "Soviet victory", scale: "Decisive", significance: 3 },
            { coords: [36.5, 50.3], name: "Battle of Prokhorovka", date: "July 12, 1943", outcome: "Largest tank battle in history", scale: "Critical", significance: 3 }
          ],
          frontLines: [
            { type: "allied", path: [[32, 60], [34, 58], [36, 56], [36, 53], [37, 51], [37, 50], [36.5, 49], [36, 47], [35, 45], [33, 43]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [37, 51], zoom: 5 }
        },
        {
          id: 15,
          date: new Date(1943, 6, 10),
          title: "Allied Invasion of Sicily",
          description: "The Allies invade Sicily, beginning the Italian Campaign and leading to the fall of Mussolini. This operation opens a new front in Southern Europe and diverts German resources from the Eastern Front.",
          phase: "Allied Advance",
          type: "allied",
          significance: "major",
          stats: {
            "Allied Forces": "160,000 troops",
            "Axis Forces": "230,000 troops",
            "Duration": "38 days",
            "Allied Air Support": "3,700 aircraft"
          },
          movements: [
            { type: "allied", path: [[12, 37], [13, 37], [14, 37], [15, 37.5]], name: "Operation Husky", units: "160,000 troops", speed: "Medium", intensity: 3 },
            { type: "allied", path: [[15, 36], [15, 37], [14.5, 38]], name: "US Seventh Army", units: "American divisions", speed: "Medium", intensity: 2 },
            { type: "allied", path: [[17, 37], [16, 37.5], [15.5, 38]], name: "British Eighth Army", units: "British and Canadian divisions", speed: "Medium", intensity: 2 }
          ],
          battles: [
            { coords: [15, 37.5], name: "Sicily Campaign", date: "July 10 - Aug 17, 1943", outcome: "Allied victory", scale: "Major", significance: 2 }
          ],
          frontLines: [
            { type: "allied", path: [[12, 38], [13, 37.5], [14, 37.5], [15, 38], [15.5, 38.5]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [14, 37], zoom: 6 }
        },
        {
          id: 16,
          date: new Date(1944, 5, 6),
          title: "D-Day Normandy Landings",
          description: "The largest seaborne invasion in history as Allied forces land on the beaches of Normandy. Operation Overlord establishes a Western Front in Europe and begins the liberation of Western Europe from Nazi control.",
          phase: "Allied Advance",
          type: "allied",
          significance: "major",
          stats: {
            "Allied Forces": "156,000 troops landed on D-Day",
            "Naval Vessels": "6,939",
            "Aircraft": "11,590",
            "Casualties": "10,000+ (4,414 confirmed dead)"
          },
          movements: [
            { type: "allied", path: [[-1, 50], [-0.5, 49.7], [0, 49.5]], name: "Operation Overlord", units: "156,000 troops", speed: "Fast", intensity: 3 },
            { type: "allied", path: [[-1.5, 49.7], [-0.7, 49.4]], name: "US Forces (Omaha/Utah)", units: "American divisions", speed: "Medium", intensity: 2 },
            { type: "allied", path: [[-0.5, 50], [-0.2, 49.6]], name: "British & Canadian Forces", units: "Commonwealth divisions", speed: "Medium", intensity: 2 }
          ],
          battles: [
            { coords: [-0.5, 49.5], name: "Normandy Landings", date: "June 6, 1944", outcome: "Allied foothold established", scale: "Historic", significance: 3 }
          ],
          frontLines: [
            { type: "allied", path: [[-1, 49.4], [-0.5, 49.5], [0, 49.6], [0.5, 49.8], [1, 49.5]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [0, 49.5], zoom: 6.5 }
        },
        {
          id: 17,
          date: new Date(1944, 6, 20),
          title: "Operation Bagration",
          description: "A massive Soviet offensive that destroys German Army Group Center and clears most of Belarus and eastern Poland. One of the most catastrophic German defeats of the war, with nearly 450,000 casualties.",
          phase: "Allied Advance",
          type: "allied",
          significance: "major",
          stats: {
            "Soviet Forces": "2.3 million troops",
            "German Forces": "800,000 troops",
            "Front Width": "700 km",
            "German Losses": "450,000 casualties, 2,000 tanks"
          },
          movements: [
            { type: "allied", path: [[30, 54], [28, 53.5], [26, 53], [24, 53]], name: "Soviet Summer Offensive", units: "2.3 million troops", speed: "Fast", intensity: 3 },
            { type: "allied", path: [[32, 56], [28, 55], [25, 54]], name: "Northern Thrust", units: "Soviet divisions", speed: "Fast", intensity: 2 },
            { type: "allied", path: [[32, 52], [28, 52], [25, 52]], name: "Southern Thrust", units: "Soviet divisions", speed: "Fast", intensity: 2 }
          ],
          battles: [
            { coords: [27, 53.9], name: "Destruction of Army Group Center", date: "June-August 1944", outcome: "Soviet victory", scale: "Decisive", significance: 3 }
          ],
          frontLines: [
            { type: "allied", path: [[24, 60], [24, 58], [24, 56], [23, 54], [22, 52], [24, 50], [26, 48], [28, 46], [30, 45]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [27, 53], zoom: 4.5 }
        },
        {
          id: 18,
          date: new Date(1944, 11, 16),
          title: "Battle of the Bulge",
          description: "Hitler's last major offensive in the West, attempting to split Allied forces in Belgium and Luxembourg. Despite initial gains, the German advance is halted and pushed back, exhausting Germany's strategic reserves.",
          phase: "Allied Advance",
          type: "axis",
          significance: "major",
          stats: {
            "German Forces": "410,000 troops",
            "Allied Forces": "705,000 troops",
            "Duration": "40 days",
            "Casualties": "German: 100,000, Allied: 81,000"
          },
          movements: [
            { type: "axis", path: [[6.1, 50], [5.6, 50.2], [5.3, 50.3]], name: "German Ardennes Offensive", units: "410,000 troops", speed: "Medium", intensity: 3 },
            { type: "allied", path: [[2.5, 49], [4, 49.5], [5.3, 50.3]], name: "Allied Counter-offensive", units: "705,000 troops", speed: "Medium", intensity: 3 },
            { type: "allied", path: [[5, 51], [5.2, 50.5]], name: "Patton's Third Army", units: "American divisions", speed: "Fast", intensity: 2 }
          ],
          battles: [
            { coords: [5.8, 50.2], name: "Battle of the Bulge", date: "Dec 16, 1944 - Jan 25, 1945", outcome: "Allied victory", scale: "Major", significance: 2 },
            { coords: [5.45, 50.05], name: "Siege of Bastogne", date: "Dec 20-27, 1944", outcome: "Allied defense held", scale: "Significant", significance: 2 }
          ],
          frontLines: [
            { type: "allied", path: [[3, 51], [4, 50.5], [5, 50], [5.3, 49.5], [5.8, 49], [6.5, 48.5], [7, 48], [7.5, 47.5]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [5.5, 50], zoom: 6.5 }
        },
        {
          id: 19,
          date: new Date(1945, 2, 13),
          title: "Allied Crossing of the Rhine",
          description: "Allied forces cross the Rhine River, the last major natural barrier into Germany. This breakthrough allows for the rapid advance into Germany's industrial heartland and signals the final phase of the European war.",
          phase: "Allied Advance",
          type: "allied",
          significance: "major",
          stats: {
            "Allied Forces": "250,000+ troops",
            "Bridgeheads Established": "Multiple across 300 km front",
            "Advance Speed": "Up to 10 km per day",
            "German Resistance": "Increasingly disorganized"
          },
          movements: [
            { type: "allied", path: [[6, 50], [7, 50.5], [8.5, 51]], name: "Operation Plunder", units: "250,000 troops", speed: "Fast", intensity: 3 },
            { type: "allied", path: [[8, 49.5], [8.5, 49.7], [9, 50]], name: "Operation Undertone", units: "300,000 troops", speed: "Fast", intensity: 2 },
            { type: "allied", path: [[7, 51], [8, 51.5], [9, 52]], name: "Northern Advance", units: "Allied divisions", speed: "Fast", intensity: 2 }
          ],
          battles: [
            { coords: [7, 51], name: "Remagen Bridge Capture", date: "March 7, 1945", outcome: "Allied strategic victory", scale: "Significant", significance: 2 },
            { coords: [8.3, 50], name: "Frankfurt Capture", date: "March 29, 1945", outcome: "Allied victory", scale: "Major", significance: 2 }
          ],
          frontLines: [
            { type: "allied", path: [[7, 54], [8, 53], [9, 52], [9, 51], [9, 50], [8.5, 49], [8, 48], [7.5, 47], [7, 46.5]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [8, 50.5], zoom: 5.5 }
        },
        {
          id: 20,
          date: new Date(1945, 3, 16),
          title: "Battle of Berlin",
          description: "The Soviet Army launches its final assault on Berlin, capturing the city and leading to Hitler's suicide and Germany's unconditional surrender. The fall of Berlin effectively ends the war in Europe.",
          phase: "Allied Advance",
          type: "allied",
          significance: "major",
          stats: {
            "Soviet Forces": "2.5 million troops",
            "German Forces": "766,000 troops",
            "Soviet Artillery": "41,600 guns",
            "Casualties": "Soviet: 81,000 dead, German: 92,000+ captured"
          },
          movements: [
            { type: "allied", path: [[14, 52.5], [13.8, 52.5], [13.5, 52.5]], name: "Soviet Berlin Strategic Offensive", units: "2.5 million troops", speed: "Fast", intensity: 3 },
            { type: "allied", path: [[14.5, 53.5], [14, 53], [13.5, 52.8]], name: "Zhukov's 1st Belorussian Front", units: "Soviet armies", speed: "Fast", intensity: 2 },
            { type: "allied", path: [[14.5, 51.5], [14, 52], [13.5, 52.3]], name: "Konev's 1st Ukrainian Front", units: "Soviet armies", speed: "Fast", intensity: 2 }
          ],
          battles: [
            { coords: [13.4, 52.5], name: "Battle of Berlin", date: "April 16 - May 2, 1945", outcome: "Soviet victory, end of War in Europe", scale: "Historic", significance: 3 },
            { coords: [14.5, 52.4], name: "Seelow Heights", date: "April 16-19, 1945", outcome: "Soviet victory", scale: "Significant", significance: 2 }
          ],
          frontLines: [
            { type: "allied", path: [[9, 54], [10, 53.5], [11, 53], [12, 52.5], [12, 51.5], [11, 50], [10, 49], [10, 48], [9.5, 47], [9, 46]] }
          ],
          theaters: ["europe"],
          mapFocus: { center: [13.5, 52.5], zoom: 6 }
        },
        {
          id: 21,
          date: new Date(1945, 7, 6),
          title: "Atomic Bombing of Japan",
          description: "The United States drops atomic bombs on Hiroshima and Nagasaki, leading to Japan's surrender and the end of World War II. These were the only nuclear weapons ever used in warfare.",
          phase: "Allied Advance",
          type: "allied",
          significance: "major",
          stats: {
            "Hiroshima Casualties": "90,000-146,000 deaths",
            "Nagasaki Casualties": "39,000-80,000 deaths",
            "Aircraft": "B-29 Superfortress bombers",
            "Bombing Date": "August 6 & 9, 1945"
          },
          movements: [
            { type: "allied", path: [[155, 15], [145, 25], [132.5, 34.5]], name: "Hiroshima Mission", units: "B-29 Superfortress bomber", speed: "Fast", intensity: 3 },
            { type: "allied", path: [[155, 15], [143, 23], [129.9, 32.8]], name: "Nagasaki Mission", units: "B-29 Superfortress bomber", speed: "Fast", intensity: 3 }
          ],
          battles: [
            { coords: [132.5, 34.5], name: "Atomic Bombing of Hiroshima", date: "August 6, 1945", outcome: "Devastation of city", scale: "Historic", significance: 3 },
            { coords: [129.9, 32.8], name: "Atomic Bombing of Nagasaki", date: "August 9, 1945", outcome: "Japan's surrender", scale: "Historic", significance: 3 }
          ],
          frontLines: [],
          theaters: ["pacific"],
          mapFocus: { center: [135, 35], zoom: 5 }
        }
      ];

      // ===== Map Creation =====
      // Create SVG groups
      const mapGroup = svg.append('g').attr('class', 'world-map-group');
      const countriesGroup = mapGroup.append('g').attr('class', 'countries-group');
      const frontLinesGroup = mapGroup.append('g').attr('class', 'front-lines-group');
      const movementsGroup = mapGroup.append('g').attr('class', 'movements-group');
      const troopsGroup = mapGroup.append('g').attr('class', 'troops-group');
      const battlesGroup = mapGroup.append('g').attr('class', 'battles-group');

      // Load world map data
      Promise.all([
        d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
      ]).then(function ([world]) {
        // Draw the base world map
        const countries = topojson.feature(world, world.objects.countries);

        countriesGroup.selectAll('path')
          .data(countries.features)
          .enter()
          .append('path')
          .attr('class', 'country')
          .attr('d', path)
          .attr('id', d => `country-${d.id}`)
          .on('mouseover', function (event, d) {
            showTooltip(getCountryName(d.id), event.pageX, event.pageY);
          })
          .on('mouseout', function () {
            hideTooltip();
          });

        // Initialize timeline with events and controls
        createTimeline();

        // Initialize control buttons
        initControls();

        // Initialize theater controls
        initTheaterControls();

        // Initialize zoom controls
        initZoomControls();

        // Initialize info panel
        initInfoPanel();

        // Hide loading overlay with a fade effect
        d3.select('.loading-overlay')
          .transition()
          .duration(800)
          .style('opacity', 0)
          .on('end', function () {
            this.style.display = 'none';

            // Start with the first event
            updateMapToEvent(0, true);

            // Show welcome notification
            showNotification('Explore WWII troop movements from 1939-1945. Click Play to begin animation.');
          });
      }).catch(error => {
        console.error('Error loading map data:', error);
        alert('Failed to load map data. Please refresh and try again.');
      });

      // ===== Timeline Creation =====
      function createTimeline() {
        const timeline = d3.select('.timeline');
        const timelineWidth = timeline.node().getBoundingClientRect().width;

        // Time scale for the timeline
        const timeScale = d3.scaleTime()
          .domain([new Date(1939, 8, 1), new Date(1945, 7, 15)])
          .range([20, timelineWidth - 20]);

        // Add year markers
        const yearMarkers = d3.select('#year-markers');

        for (let year = 1939; year <= 1945; year++) {
          const yearPosition = timeScale(new Date(year, 0, 1));

          yearMarkers.append('div')
            .attr('class', 'year-marker')
            .style('left', yearPosition + 'px');

          yearMarkers.append('div')
            .attr('class', 'year-label')
            .style('left', yearPosition + 'px')
            .text(year);
        }

        // Add war phases
        const phasesContainer = d3.select('#war-phases');

        warPhases.forEach(phase => {
          const phaseStart = timeScale(phase.start);
          const phaseEnd = timeScale(phase.end);
          const phaseWidth = phaseEnd - phaseStart;

          phasesContainer.append('div')
            .attr('class', 'phase')
            .style('left', phaseStart + 'px')
            .style('width', phaseWidth + 'px')
            .style('background-color', phase.color)
            .text(phase.name);
        });

        // Add event markers
        events.forEach((event, i) => {
          const markerPosition = timeScale(event.date);

          const markerClasses = ['event-marker'];
          if (event.type === 'axis') markerClasses.push('axis-event');
          if (event.type === 'allied') markerClasses.push('allied-event');
          if (event.significance === 'major') markerClasses.push('major-event');

          const marker = timeline.append('div')
            .attr('class', markerClasses.join(' '))
            .attr('id', `event-marker-${i}`)
            .style('left', markerPosition + 'px')
            .on('click', () => {
              currentEventIndex = i;
              updateMapToEvent(i, true);
              updateTimeIndicator();

              if (isPlaying) {
                togglePlayPause();
              }
            });

          marker.append('div')
            .attr('class', 'timeline-tooltip')
            .html(`${formatDate(event.date, true)}<br>${event.title}`);
        });

        // Add time indicator
        const timeIndicator = d3.select('#time-indicator');
        const currentDate = d3.select('#current-date');

        // Initial position
        timeIndicator.style('left', timeScale(events[0].date) + 'px');
        currentDate.text(formatDate(events[0].date));

        // Initialize timeline progress bar
        d3.select('#timeline-progress')
          .style('width', '0px');
      }

      // ===== Controls Initialization =====
      function initControls() {
        const playPauseBtn = document.getElementById('play-pause-btn');
        const previousBtn = document.getElementById('previous-btn');
        const nextBtn = document.getElementById('next-btn');
        const resetBtn = document.getElementById('reset-btn');

        playPauseBtn.addEventListener('click', togglePlayPause);
        previousBtn.addEventListener('click', goToPreviousEvent);
        nextBtn.addEventListener('click', goToNextEvent);
        resetBtn.addEventListener('click', resetVisualization);

        function updateButtonStates() {
          previousBtn.disabled = state.currentEventIndex === 0;
          nextBtn.disabled = state.currentEventIndex === events.length - 1;
        }

        // Initial button states
        updateButtonStates();

        // Export update function to global state
        state.updateButtonStates = updateButtonStates;
      }

      function initTheaterControls() {
        const theaterButtons = document.querySelectorAll('.theater-button');

        theaterButtons.forEach(button => {
          button.addEventListener('click', function () {
            const theater = this.getAttribute('data-theater');

            // Update active class
            theaterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // Update state
            state.activeTheater = theater;

            // Focus map on theater
            focusMapOnTheater(theater);

            // Update current event (without animation)
            updateMapToEvent(state.currentEventIndex, false);
          });
        });
      }

      function initZoomControls() {
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomResetBtn = document.getElementById('zoom-reset');

        zoomInBtn.addEventListener('click', function () {
          const newZoom = Math.min(state.zoomLevel * 1.5, config.zoomExtent[1]);
          applyZoom(newZoom, state.mapTranslate);
        });

        zoomOutBtn.addEventListener('click', function () {
          const newZoom = Math.max(state.zoomLevel / 1.5, config.zoomExtent[0]);
          applyZoom(newZoom, state.mapTranslate);
        });

        zoomResetBtn.addEventListener('click', function () {
          applyZoom(config.defaultZoom, [0, 0]);
        });
      }

      function initInfoPanel() {
        const infoPanel = document.querySelector('.info-panel');
        const closeBtn = infoPanel.querySelector('.close-btn');

        closeBtn.addEventListener('click', function () {
          infoPanel.classList.remove('active');
        });
      }

      // ===== Map Update Functions =====
      function updateMapToEvent(eventIndex, animated = true) {
        // Clear any existing animation timers
        clearTimeout(state.animationTimer);

        // Get current event
        const event = events[eventIndex];
        state.currentEventIndex = eventIndex;

        // Update button states
        if (state.updateButtonStates) {
          state.updateButtonStates();
        }

        // Update timeline marker highlights
        updateEventMarkers();

        // Update date display
        document.getElementById('current-date').textContent = formatDate(event.date);

        // Update info panel
        updateInfoPanel(event);

        // If this event is in current theater or global view, focus on it
        if (state.activeTheater === 'global' || event.theaters.includes(state.activeTheater)) {
          if (event.mapFocus) {
            focusMapOnCoordinates(event.mapFocus.center, event.mapFocus.zoom);
          }
        }

        // Update country statuses based on date
        updateCountryStatus(event.date);

        // Clear existing battle markers and front lines
        frontLinesGroup.selectAll('*').remove();
        battlesGroup.selectAll('*').remove();

        // If we're animating, clear and animate troop movements
        if (animated) {
          movementsGroup.selectAll('*').remove();
          troopsGroup.selectAll('*').remove();

          // Add and animate front lines
          animateFrontLines(event);

          // Animate troop movements
          animateTroopMovements(event);

          // Show battles with delay
          setTimeout(() => {
            showBattles(event, true);
          }, config.animationDuration / 2);
        } else {
          // Just show movements without animation
          movementsGroup.selectAll('*').remove();
          troopsGroup.selectAll('*').remove();

          showFrontLines(event);
          showTroopMovements(event);
          showBattles(event, false);
        }

        // Update time indicator on timeline
        updateTimeIndicator();
      }

      function updateEventMarkers() {
        // Remove active class from all markers
        d3.selectAll('.event-marker').classed('active', false);

        // Add active class to current marker
        d3.select(`#event-marker-${state.currentEventIndex}`).classed('active', true);
      }

      function updateTimeIndicator() {
        const timeline = d3.select('.timeline');
        const timelineWidth = timeline.node().getBoundingClientRect().width;

        // Time scale for the timeline
        const timeScale = d3.scaleTime()
          .domain([new Date(1939, 8, 1), new Date(1945, 7, 15)])
          .range([20, timelineWidth - 20]);

        const currentEvent = events[state.currentEventIndex];
        const markerPosition = timeScale(currentEvent.date);

        // Update time indicator position
        d3.select('#time-indicator')
          .transition()
          .duration(500)
          .style('left', markerPosition + 'px');

        // Update progress bar width
        d3.select('#timeline-progress')
          .transition()
          .duration(500)
          .style('width', markerPosition + 'px');
      }

      function updateInfoPanel(event) {
        const infoPanel = document.querySelector('.info-panel');
        const dateElement = document.getElementById('current-event-date');
        const titleElement = document.getElementById('event-title');
        const descriptionElement = document.getElementById('event-description');
        const statsElement = document.getElementById('event-stats');
        const battleDetailElement = document.getElementById('battle-detail');

        // Update content
        dateElement.textContent = formatDate(event.date);
        titleElement.textContent = event.title;
        descriptionElement.textContent = event.description;

        // Update stats
        let statsHTML = '';
        if (event.stats) {
          for (const [label, value] of Object.entries(event.stats)) {
            statsHTML += `<div class="stat-row">
              <span class="stat-label">${label}</span>
              <span class="stat-value">${value}</span>
            </div>`;
          }
        }
        statsElement.innerHTML = statsHTML;

        // Update battle details
        let battleHTML = '';
        if (event.battles && event.battles.length > 0) {
          const mainBattle = event.battles[0];
          battleHTML = `
            <div class="battle-title">${mainBattle.name}</div>
            <div class="battle-info">
              <strong>Date:</strong> ${mainBattle.date}<br>
              <strong>Outcome:</strong> ${mainBattle.outcome}<br>
              <strong>Significance:</strong> ${mainBattle.scale}
            </div>
          `;
        }
        battleDetailElement.innerHTML = battleHTML;

        // Show the panel
        infoPanel.classList.add('active');
      }

      function updateCountryStatus(currentDate) {
        // Reset all countries to default
        svg.selectAll('.country')
          .attr('class', 'country');

        // Determine country control at this date
        // This would be a complex function based on historical data
        // For now, we'll use a simplified approach

        // Axis core countries
        const axisCore = [276, 380, 392]; // Germany, Italy, Japan

        // Allied core countries
        const alliedCore = [826, 840, 124, 643]; // UK, US, Canada, Russia (used for USSR)

        // Update based on date ranges
        svg.selectAll('.country')
          .attr('class', function (d) {
            const id = d.id;
            const baseClass = 'country';

            // Core Axis countries
            if (axisCore.includes(id)) {
              return `${baseClass} axis`;
            }

            // Core Allied countries
            if (alliedCore.includes(id)) {
              // USSR was neutral until June 22, 1941
              if (id === 643 && currentDate < new Date(1941, 5, 22)) {
                return `${baseClass} neutral`;
              }
              // US was neutral until December 7, 1941
              if (id === 840 && currentDate < new Date(1941, 11, 7)) {
                return `${baseClass} neutral`;
              }
              return `${baseClass} allied`;
            }

            // Occupied countries based on date

            // Poland (occupied from Sept 1939)
            if (id === 616 && currentDate >= new Date(1939, 8, 15)) {
              return `${baseClass} occupied`;
            }

            // France (occupied from June 1940)
            if (id === 250 && currentDate >= new Date(1940, 5, 25)) {
              return `${baseClass} occupied`;
            }

            // Denmark, Norway, Belgium, Netherlands, Luxembourg (occupied from May 1940)
            if ([208, 578, 56, 528, 442].includes(id) && currentDate >= new Date(1940, 4, 15)) {
              return `${baseClass} occupied`;
            }

            // Yugoslavia, Greece (occupied from April 1941)
            if ([300, 891].includes(id) && currentDate >= new Date(1941, 3, 30)) {
              return `${baseClass} occupied`;
            }

            // Liberation phases would be added here

            return baseClass;
          });
      }

      // ===== Animation Functions =====
      function animateTroopMovements(event) {
        event.movements.forEach(movement => {
          const lineGenerator = d3.line()
            .x(d => projection(d)[0])
            .y(d => projection(d)[1])
            .curve(d3.curveBasis);

          // Create the path for movement line
          const movementPath = movementsGroup.append('path')
            .datum(movement.path)
            .attr('class', `movement-line ${movement.type}-line`)
            .attr('d', lineGenerator)
            .style('stroke-width', Math.min(Math.max(movement.intensity, 1), 3) * 2)
            .style('opacity', 0);

          // Calculate path length for animation
          const pathLength = movementPath.node().getTotalLength();

          // Animate the path appearance
          movementPath
            .style('stroke-dasharray', pathLength)
            .style('stroke-dashoffset', pathLength)
            .style('opacity', 0.8)
            .transition()
            .duration(config.animationDuration)
            .ease(d3.easeLinear)
            .style('stroke-dashoffset', 0)
            .on('end', function () {
              // Add troop markers along the path
              const numMarkers = Math.min(5, Math.max(1, movement.path.length - 1));
              const troopPath = movement.path.slice(); // Copy to avoid modifying original

              for (let i = 1; i <= numMarkers; i++) {
                const t = i / (numMarkers + 1);
                const point = d3.select(this).node().getPointAtLength(pathLength * t);

                // Calculate angle of the path at this point for arrow direction
                const pointBefore = d3.select(this).node().getPointAtLength(pathLength * t - 10);
                const angle = Math.atan2(point.y - pointBefore.y, point.x - pointBefore.x) * 180 / Math.PI;

                // Add troop marker
                troopsGroup.append('line')
                  .attr('class', `troop-marker ${movement.type}-troops`)
                  .attr('x1', point.x - 8)
                  .attr('y1', point.y)
                  .attr('x2', point.x + 8)
                  .attr('y2', point.y)
                  .style('stroke-width', Math.min(Math.max(movement.intensity, 1), 3) * 2)
                  .style('transform', `rotate(${angle}deg)`)
                  .style('transform-origin', `${point.x}px ${point.y}px`);
              }

              // Add arrow at the end of the path
              const endPoint = movement.path[movement.path.length - 1];
              const projectedEnd = projection(endPoint);

              // Calculate angle for the arrow
              const preEndPoint = d3.select(this).node().getPointAtLength(pathLength - 10);
              const arrowAngle = Math.atan2(projectedEnd[1] - preEndPoint.y, projectedEnd[0] - preEndPoint.x) * 180 / Math.PI;

              movementsGroup.append('path')
                .attr('d', `M${projectedEnd[0]},${projectedEnd[1]} l-12,-6 l0,12 z`)
                .attr('class', `${movement.type}-line`)
                .attr('stroke', 'none')
                .style('transform', `rotate(${arrowAngle}deg)`)
                .style('transform-origin', `${projectedEnd[0]}px ${projectedEnd[1]}px`)
                .style('opacity', 0)
                .transition()
                .duration(300)
                .style('opacity', 0.9);
            });

          // Add tooltip behavior
          movementPath
            .on('mouseover', function (event) {
              const speedMap = {
                'Slow': 'Slow advance',
                'Medium': 'Moderate pace',
                'Fast': 'Rapid advance'
              };

              showTooltip(`
                <strong>${movement.name}</strong><br>
                Forces: ${movement.units}<br>
                Speed: ${speedMap[movement.speed] || movement.speed}
              `, event.pageX, event.pageY);
            })
            .on('mouseout', hideTooltip);
        });
      }

      function showTroopMovements(event) {
        event.movements.forEach(movement => {
          const lineGenerator = d3.line()
            .x(d => projection(d)[0])
            .y(d => projection(d)[1])
            .curve(d3.curveBasis);

          // Create the path for movement line
          const movementPath = movementsGroup.append('path')
            .datum(movement.path)
            .attr('class', `movement-line ${movement.type}-line`)
            .attr('d', lineGenerator)
            .style('stroke-width', Math.min(Math.max(movement.intensity, 1), 3) * 2)
            .style('opacity', 0.8);

          // Calculate path length for positioning troop markers
          const pathLength = movementPath.node().getTotalLength();

          // Add troop markers along the path
          const numMarkers = Math.min(5, Math.max(1, movement.path.length - 1));

          for (let i = 1; i <= numMarkers; i++) {
            const t = i / (numMarkers + 1);
            const point = movementPath.node().getPointAtLength(pathLength * t);

            // Calculate angle of the path at this point for arrow direction
            const pointBefore = movementPath.node().getPointAtLength(pathLength * t - 10);
            const angle = Math.atan2(point.y - pointBefore.y, point.x - pointBefore.x) * 180 / Math.PI;

            // Add troop marker
            troopsGroup.append('line')
              .attr('class', `troop-marker ${movement.type}-troops`)
              .attr('x1', point.x - 8)
              .attr('y1', point.y)
              .attr('x2', point.x + 8)
              .attr('y2', point.y)
              .style('stroke-width', Math.min(Math.max(movement.intensity, 1), 3) * 2)
              .style('transform', `rotate(${angle}deg)`)
              .style('transform-origin', `${point.x}px ${point.y}px`);
          }

          // Add arrow at the end of the path
          const endPoint = movement.path[movement.path.length - 1];
          const projectedEnd = projection(endPoint);

          // Calculate angle for the arrow
          const preEndPoint = movementPath.node().getPointAtLength(pathLength - 10);
          const arrowAngle = Math.atan2(projectedEnd[1] - preEndPoint.y, projectedEnd[0] - preEndPoint.x) * 180 / Math.PI;

          movementsGroup.append('path')
            .attr('d', `M${projectedEnd[0]},${projectedEnd[1]} l-12,-6 l0,12 z`)
            .attr('class', `${movement.type}-line`)
            .attr('stroke', 'none')
            .style('transform', `rotate(${arrowAngle}deg)`)
            .style('transform-origin', `${projectedEnd[0]}px ${projectedEnd[1]}px`)
            .style('opacity', 0.9);

          // Add tooltip behavior
          movementPath
            .on('mouseover', function (event) {
              const speedMap = {
                'Slow': 'Slow advance',
                'Medium': 'Moderate pace',
                'Fast': 'Rapid advance'
              };

              showTooltip(`
                <strong>${movement.name}</strong><br>
                Forces: ${movement.units}<br>
                Speed: ${speedMap[movement.speed] || movement.speed}
              `, event.pageX, event.pageY);
            })
            .on('mouseout', hideTooltip);
        });
      }

      function animateFrontLines(event) {
        if (!event.frontLines || event.frontLines.length === 0) return;

        event.frontLines.forEach(frontLine => {
          const lineGenerator = d3.line()
            .x(d => projection(d)[0])
            .y(d => projection(d)[1])
            .curve(d3.curveBasis);

          const frontLinePath = frontLinesGroup.append('path')
            .datum(frontLine.path)
            .attr('class', `front-line ${frontLine.type}-front`)
            .attr('d', lineGenerator)
            .style('opacity', 0);

          const pathLength = frontLinePath.node().getTotalLength();

          frontLinePath
            .style('stroke-dasharray', pathLength)
            .style('stroke-dashoffset', pathLength)
            .style('opacity', 0.8)
            .transition()
            .delay(config.animationDuration / 2)
            .duration(config.animationDuration / 2)
            .ease(d3.easeLinear)
            .style('stroke-dashoffset', 0);
        });
      }

      function showFrontLines(event) {
        if (!event.frontLines || event.frontLines.length === 0) return;

        event.frontLines.forEach(frontLine => {
          const lineGenerator = d3.line()
            .x(d => projection(d)[0])
            .y(d => projection(d)[1])
            .curve(d3.curveBasis);

          frontLinesGroup.append('path')
            .datum(frontLine.path)
            .attr('class', `front-line ${frontLine.type}-front`)
            .attr('d', lineGenerator)
            .style('opacity', 0.8);
        });
      }

      function showBattles(event, animated = true) {
        if (!event.battles || event.battles.length === 0) return;

        event.battles.forEach(battle => {
          const coords = projection(battle.coords);
          if (!coords) return; // Skip if outside projection

          // Add battle marker group
          const battleGroup = battlesGroup.append('g')
            .attr('class', 'battle-marker')
            .attr('transform', `translate(${coords[0]}, ${coords[1]})`)
            .style('opacity', animated ? 0 : 1);

          // Add battle point (circle)
          const size = Math.min(Math.max(battle.significance || 1, 1), 3) * 4;

          const battlePoint = battleGroup.append('circle')
            .attr('class', 'battle-point')
            .attr('r', size);

          // Add pulse effect
          const battlePulse = battleGroup.append('circle')
            .attr('class', 'battle-pulse')
            .attr('r', 5);

          if (animated) {
            // Animate battleGroup fade in
            battleGroup.transition()
              .duration(500)
              .style('opacity', 1)
              .on('end', function () {
                // Start pulse animation after fade in
                battlePulse.call(pulse);
              });

            // Animate battle point appearance
            battlePoint
              .attr('r', 0)
              .transition()
              .duration(800)
              .attr('r', size)
              .transition()
              .duration(400)
              .attr('r', size * 0.8)
              .transition()
              .duration(200)
              .attr('r', size);
          } else {
            // Start pulse right away for non-animated version
            battlePulse.call(pulse);
          }

          // Battle tooltip
          battleGroup
            .on('mouseover', function (event) {
              showTooltip(`
                <strong>${battle.name}</strong><br>
                ${battle.date}<br>
                Outcome: ${battle.outcome}<br>
                Scale: ${battle.scale}
              `, event.pageX, event.pageY);
            })
            .on('mouseout', hideTooltip);
        });

        // Pulse animation function
        function pulse(selection) {
          selection
            .transition()
            .duration(1500)
            .attr('r', 20)
            .style('opacity', 0)
            .on('end', function () {
              d3.select(this)
                .attr('r', 5)
                .style('opacity', 0.7)
                .call(pulse);
            });
        }
      }

      // ===== Control Functions =====
      function togglePlayPause() {
        state.isPlaying = !state.isPlaying;
        const btn = document.getElementById('play-pause-btn');

        if (state.isPlaying) {
          btn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="6" y="4" width="4" height="16" fill="currentColor"/>
              <rect x="14" y="4" width="4" height="16" fill="currentColor"/>
            </svg>
            Pause
          `;
          playNextEvent();
        } else {
          btn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
            </svg>
            Play
          `;
          clearTimeout(state.animationTimer);
        }
      }

      function playNextEvent() {
        updateMapToEvent(state.currentEventIndex, true);

        state.animationTimer = setTimeout(() => {
          state.currentEventIndex = (state.currentEventIndex + 1) % events.length;

          if (state.currentEventIndex === 0) {
            // Reached the end, stop playing
            togglePlayPause();
            showNotification('End of timeline reached. Click Play to start again.');
          } else if (state.isPlaying) {
            playNextEvent();
          }
        }, config.animationDuration + config.pauseBetweenEvents);
      }

      function goToPreviousEvent() {
        if (state.currentEventIndex > 0) {
          state.currentEventIndex--;
          updateMapToEvent(state.currentEventIndex, true);
        }
      }

      function goToNextEvent() {
        if (state.currentEventIndex < events.length - 1) {
          state.currentEventIndex++;
          updateMapToEvent(state.currentEventIndex, true);
        }
      }

      function resetVisualization() {
        // Stop playing if it's currently playing
        if (state.isPlaying) {
          togglePlayPause();
        }

        // Reset to first event
        state.currentEventIndex = 0;
        updateMapToEvent(0, true);

        // Reset map view
        resetMapView();

        showNotification('Timeline reset to the beginning of World War II.');
      }

      // ===== Map Navigation Functions =====
      function focusMapOnTheater(theater) {
        switch (theater) {
          case 'europe':
            focusMapOnCoordinates([15, 50], 3);
            break;
          case 'pacific':
            focusMapOnCoordinates([150, 10], 2);
            break;
          case 'africa':
            focusMapOnCoordinates([25, 0], 2.5);
            break;
          case 'global':
          default:
            resetMapView();
            break;
        }
      }

      function focusMapOnCoordinates(coordinates, zoomLevel) {
        const [x, y] = coordinates;
        const [px, py] = projection([x, y]);

        if (!px || !py) return; // Skip if outside projection

        const width = svg.attr('width') || svg.node().getBoundingClientRect().width;
        const height = svg.attr('height') || svg.node().getBoundingClientRect().height;

        const tx = width / 2 - px * zoomLevel;
        const ty = height / 2 - py * zoomLevel;

        applyZoom(zoomLevel, [tx, ty]);
      }

      function applyZoom(zoomLevel, translate) {
        // Update state
        state.zoomLevel = zoomLevel;
        state.mapTranslate = translate;

        // Apply transform to map
        const transform = d3.zoomIdentity
          .translate(translate[0], translate[1])
          .scale(zoomLevel);

        svg.transition()
          .duration(750)
          .call(zoom.transform, transform);
      }

      function resetMapView() {
        applyZoom(config.defaultZoom, [0, 0]);
      }

      // ===== Helper Functions =====
      function showTooltip(content, x, y) {
        clearTimeout(state.tooltipTimer);

        tooltip.html(content)
          .style('left', (x + 15) + 'px')
          .style('top', (y - 15) + 'px')
          .transition()
          .duration(200)
          .style('opacity', 1);
      }

      function hideTooltip() {
        state.tooltipTimer = setTimeout(() => {
          tooltip.transition()
            .duration(500)
            .style('opacity', 0);
        }, 100);
      }

      function showNotification(message) {
        const notification = document.getElementById('notification');

        // Clear any existing timeout
        if (state.notificationTimer) {
          clearTimeout(state.notificationTimer);
        }

        // Set content and show notification
        notification.textContent = message;
        notification.classList.add('active');

        // Hide after 5 seconds
        state.notificationTimer = setTimeout(() => {
          notification.classList.remove('active');
        }, 5000);
      }

      function formatDate(date, short = false) {
        const options = short
          ? { year: 'numeric', month: 'short' }
          : { year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      }

      function getCountryName(id) {
        const countryMap = {
          276: "Germany",
          840: "United States",
          826: "United Kingdom",
          250: "France",
          380: "Italy",
          392: "Japan",
          643: "Soviet Union",
          156: "China",
          616: "Poland",
          124: "Canada",
          36: "Australia",
          528: "Netherlands",
          56: "Belgium",
          578: "Norway",
          208: "Denmark",
          300: "Greece",
          620: "Portugal",
          724: "Spain",
          752: "Sweden",
          756: "Switzerland",
          792: "Turkey",
          348: "Hungary",
          642: "Romania",
          100: "Bulgaria",
          705: "Slovenia",
          191: "Croatia",
          688: "Serbia",
          233: "Estonia",
          428: "Latvia",
          440: "Lithuania",
          203: "Czech Republic",
          703: "Slovakia",
          40: "Austria",
          246: "Finland",
          372: "Ireland",
          442: "Luxembourg",
          804: "Ukraine",
          112: "Belarus",
          31: "Azerbaijan",
          51: "Armenia",
          268: "Georgia"
        };

        return countryMap[id] || "Unknown Country";
      }
    });
  </script>
</body>

</html>